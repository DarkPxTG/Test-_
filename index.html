<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Ultimate Messenger UI (Realtime Active)</title>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
  // **Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ø´Ù…Ø§**
  const firebaseConfig = {
    apiKey: "AIzaSyAxchyTNviRo9Fu0B8ar_wpWeIisdYfolI",
    authDomain: "chat-c92db.firebaseapp.com",
    projectId: "chat-c92db",
    storageBucket: "chat-c92db.firebasestorage.app",
    messagingSenderId: "1001733156664",
    appId: "1:1001733156664:web:37601df09baa29cef01bcd",
    measurementId: "G-T1FG1BW244"
  };

  // Initialize Firebase Variables
  let app;
  let auth;
  let db; 
  let currentUserID = null; 
  let currentUsername = null;
  let currentUserEmail = null; // Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø§ÛŒÙ…ÛŒÙ„
  let currentRandomID = null; // **Ø¬Ø¯ÛŒØ¯: ID Ø±Ù†Ø¯ÙˆÙ… Û±Û± Ø±Ù‚Ù…ÛŒ**
  let currentChatListener = null; 
  let activeChatData = null; 
  
  // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ú†Øª Ø¨Ø±Ø§ÛŒ ØªØ³Øª ØªÛŒÚ©â€ŒÙ‡Ø§
  const chatUsers = {
      "news_channel_1": ["user_123", "user_456"],
      "sarah_jones_2": ["user_123", "sarah_id"],
      "dev_team_3": ["user_123", "user_b", "user_c"],
      "bot_4": ["user_123"] // Bot Helper
  };

  let pressTimer = null;
  let currentItem = null;
  let currentChatInfo = null;

  // **ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: ØªÙˆÙ„ÛŒØ¯ ID Ø±Ù†Ø¯ÙˆÙ… Û±Û± Ø±Ù‚Ù…ÛŒ**
  function generateRandomID() {
      return Math.floor(10000000000 + Math.random() * 90000000000).toString();
  }
  
  // **ØªØ§Ø¨Ø¹ Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯Ù‡: Ø«Ø¨Øª Ù†Ø§Ù… Ùˆ ÙˆØ±ÙˆØ¯**
  function registerOrLogin(isRegister) {
      const username = document.getElementById('auth-username').value;
      const password = document.getElementById('auth-password').value;
      const email = document.getElementById('auth-email').value || 'example@user.com'; // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø§ÛŒÙ…ÛŒÙ„

      if (!username || !password) {
          showToast("Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.");
          return;
      }
      
      let storedUser = localStorage.getItem('currentUser');
      let user = storedUser ? JSON.parse(storedUser) : null;
      
      if (isRegister) {
          // ØªÙˆÙ„ÛŒØ¯ ID Ø±Ù†Ø¯ÙˆÙ… ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø± Ø«Ø¨Øª Ù†Ø§Ù…
          currentRandomID = generateRandomID();
          currentUserID = "user_" + username.replace(/[^a-z0-9]/gi, '_').toLowerCase();
          currentUsername = username;
          currentUserEmail = email;

          localStorage.setItem('currentUser', JSON.stringify({
              uid: currentUserID,
              username: currentUsername,
              email: currentUserEmail,
              randomId: currentRandomID, // Ø°Ø®ÛŒØ±Ù‡ ID Ø±Ù†Ø¯ÙˆÙ…
              password: password 
          }));
          
      } else {
          // Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯ÛŒÙ†ØŒ Ø§Ú¯Ø± Ø¯Ø± localStorage Ø¨ÙˆØ¯ØŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†
          if (user && user.username === username && user.password === password) {
              currentUserID = user.uid;
              currentUsername = user.username;
              currentUserEmail = user.email;
              currentRandomID = user.randomId;
          } else {
              showToast("Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ±ÙˆØ¯ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª ÛŒØ§ Ú©Ø§Ø±Ø¨Ø± Ø«Ø¨Øª Ù†Ø§Ù… Ù†Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª.");
              return;
          }
      }

      // Ù†Ù…Ø§ÛŒØ´ UI Ø§ØµÙ„ÛŒ
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('app-ui').style.display = 'flex';
      
      showToast(isRegister ? "Ø«Ø¨Øª Ù†Ø§Ù… Ùˆ ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!" : "ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!");
      initializeFirebase(); 
      
      // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ø§Ù… Ø¯Ø± Drawer
      updateDrawerInfo();
  }
  
  function updateDrawerInfo() {
      document.getElementById('drawer-avatar-name').textContent = currentUsername || 'Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒÙ‡Ù…Ø§Ù†';
      document.getElementById('drawer-avatar-phone').textContent = currentRandomID || 'ID: ...'; // Ù†Ù…Ø§ÛŒØ´ ID Ø±Ù†Ø¯ÙˆÙ…
      document.getElementById('drawer-avatar').textContent = currentUsername ? currentUsername[0] : 'G';
  }

  function showAuthScreen() {
      const storedUser = localStorage.getItem('currentUser');
      if (storedUser) {
          const user = JSON.parse(storedUser);
          currentUserID = user.uid;
          currentUsername = user.username;
          currentUserEmail = user.email;
          currentRandomID = user.randomId; // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ID Ø±Ù†Ø¯ÙˆÙ…
          
          document.getElementById('auth-screen').style.display = 'none';
          document.getElementById('app-ui').style.display = 'flex';
          
          updateDrawerInfo();
          
          initializeFirebase();
      } else {
          document.getElementById('auth-screen').style.display = 'flex';
          document.getElementById('app-ui').style.display = 'none';
      }
  }

  // Function to initialize all Firebase services
  function initializeFirebase() {
      if (!firebase.apps.length) {
          app = firebase.initializeApp(firebaseConfig);
      } else {
          app = firebase.app();
      }
      
      auth = firebase.auth();
      db = firebase.firestore();

      if (currentUserID) {
          listenToUserChats();
          listenForActiveStories();
      } 
  }

  // ... (Ø³Ø§ÛŒØ± ØªÙˆØ§Ø¨Ø¹ Firebase: listenToUserChatsØŒ sendMessageØŒ updateMessageReadStatusØŒ listenForChatMessages) ...

  function openChatView(chatInfo) {
      if (!chatInfo || !chatInfo.chatId) return;

      activeChatData = chatInfo; 
      
      // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡Ø¯Ø± Ú†Øª
      document.getElementById('chat-name-display').textContent = chatInfo.name || 'Unknown Chat';
      document.getElementById('chat-status-display').textContent = chatInfo.status || '...';
      document.getElementById('chat-avatar-display').textContent = chatInfo.avatar || '?';
      
      // **Ø¬Ø¯ÛŒØ¯: Ú©Ù†ØªØ±Ù„ Ù‚Ø§Ø¨Ù„ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… (Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù†Ø§Ù„ Bot Helper)**
      const messageBar = document.getElementById('message-bar');
      const isBotHelper = chatInfo.chatId === 'bot_4';
      
      if (isBotHelper) {
          messageBar.classList.remove('active');
      } else {
          messageBar.classList.add('active');
      }
      
      // Ù†Ù…Ø§ÛŒØ´ Ù†Ù…Ø§ÛŒ Ú†Øª Ùˆ Ù†ÙˆØ§Ø± Ù¾ÛŒØ§Ù…
      document.getElementById('chat-view').classList.add('active');
      document.getElementById('compose-button').style.opacity = '0';
      document.getElementById('compose-button').style.pointerEvents = 'none';

      listenForChatMessages(chatInfo.chatId);
  }

  // --- Story Simulation (Logic kept but reduced due to user request) ---
  
  let currentStoriesListener = null;

  function listenForActiveStories() {
    // ... (Ù…Ù†Ø·Ù‚ listenForActiveStories - Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø§Ø² Ù¾Ø§Ø³Ø® Ù‚Ø¨Ù„ÛŒ) ...
  }
  
  function updateStoriesUI(storiesData) {
    // ... (Ù…Ù†Ø·Ù‚ updateStoriesUI - Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø§Ø² Ù¾Ø§Ø³Ø® Ù‚Ø¨Ù„ÛŒ) ...
  }
  
  function saveStoryMetadataToFirestore(file) {
    // ... (Ù…Ù†Ø·Ù‚ saveStoryMetadataToFirestore - Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø§Ø² Ù¾Ø§Ø³Ø® Ù‚Ø¨Ù„ÛŒ) ...
  }

  function simulateStoryProgress(file) {
    // ... (Ù…Ù†Ø·Ù‚ simulateStoryProgress - Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø§Ø² Ù¾Ø§Ø³Ø® Ù‚Ø¨Ù„ÛŒ) ...
  }

  function handleStoryFileSelect(event) {
    // ... (Ù…Ù†Ø·Ù‚ handleStoryFileSelect - Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø§Ø² Ù¾Ø§Ø³Ø® Ù‚Ø¨Ù„ÛŒ) ...
  }

  // --- Utility Functions ---

  function flash(message) {
      showToast(message);
  }

  function showToast(message) {
      const toast = document.createElement('div');
      toast.style.cssText = 'position:fixed;bottom:60px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);color:white;padding:10px 15px;border-radius:20px;z-index:5000;font-size:14px;transition:opacity 0.3s;';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
          toast.style.opacity = '0';
          setTimeout(() => toast.remove(), 300);
      }, 3000);
  }
  
  // **Ø¬Ø¯ÛŒØ¯: Ù…Ù†Ø·Ù‚ Ø§Ù†ØªØ®Ø§Ø¨ Ø§ÛŒÙ…ÙˆØ¬ÛŒ**
  const EMOJIS = ['ğŸ˜Š', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ‘', 'â¤ï¸', 'ğŸ”¥', 'ğŸ¤”', 'ğŸ‰', 'ğŸŒŸ'];

  function toggleEmojiPicker() {
      const picker = document.getElementById('emoji-picker');
      picker.classList.toggle('active');
      
      if (picker.classList.contains('active') && picker.innerHTML === '') {
          EMOJIS.forEach(emoji => {
              const span = document.createElement('span');
              span.textContent = emoji;
              span.className = 'emoji-item clickable';
              span.onclick = () => selectEmoji(emoji);
              picker.appendChild(span);
          });
      }
  }

  function selectEmoji(emoji) {
      const input = document.getElementById('chat-input');
      // Ø¯Ø±Ø¬ Ø§ÛŒÙ…ÙˆØ¬ÛŒ Ø¯Ø± Ù…Ø­Ù„ Ú©Ø±Ø³Ø±
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const value = input.value;
      
      input.value = value.substring(0, start) + emoji + value.substring(end);
      input.focus();
      input.selectionEnd = start + emoji.length;
      updateSendButton();
      
      document.getElementById('emoji-picker').classList.remove('active');
  }

  // **Ø¬Ø¯ÛŒØ¯: Ù†Ù…Ø§ÛŒØ´ Ù…Ø´Ø®ØµØ§Øª Ø§Ú©Ø§Ù†Øª**
  function showAccountInfo() {
      closeDrawer();
      const info = `
          **Ù…Ø´Ø®ØµØ§Øª Ø­Ø³Ø§Ø¨**
          
          **Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ:** ${currentUsername}
          **Ø§ÛŒÙ…ÛŒÙ„ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡:** ${currentUserEmail}
          **ID Ø±Ù†Ø¯ÙˆÙ… (Û±Û± Ø±Ù‚Ù…ÛŒ):** ${currentRandomID}
          **ID ÙÙ†ÛŒ (UID):** ${currentUserID}
      `;
      alert(info);
  }

  // **Ø¬Ø¯ÛŒØ¯: Ù…Ù†Ø·Ù‚ Ø´Ø±ÙˆØ¹ Ú¯Ø±ÙˆÙ‡/Ú©Ø§Ù†Ø§Ù„ (Ù‚Ù„Ù… Ø¢Ø¨ÛŒ)**
  function startNewChat() {
      closeDrawer();
      const chatType = prompt("Ù†ÙˆØ¹ Ú†Øª Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯: (Ú¯Ø±ÙˆÙ‡) ÛŒØ§ (Ú©Ø§Ù†Ø§Ù„)");
      if (!chatType) return;
      
      const chatName = prompt(`Ù†Ø§Ù… ${chatType} Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:`);
      if (!chatName) return;

      const userIDsString = prompt("ID Ø±Ù†Ø¯ÙˆÙ… Û±Û± Ø±Ù‚Ù…ÛŒ Ø§Ø¹Ø¶Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¬Ø¯Ø§ Ú©Ù†ÛŒØ¯ØŒ Ø§Ø¯Ù…ÛŒÙ† Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯):");
      
      const isGroup = chatType.toLowerCase() === 'Ú¯Ø±ÙˆÙ‡';
      const isChannel = chatType.toLowerCase() === 'Ú©Ø§Ù†Ø§Ù„';

      if (!isGroup && !isChannel) {
          showToast("Ù†ÙˆØ¹ Ú†Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.");
          return;
      }

      // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ÛŒØ§ÙØªÙ† UID Ø¨Ø± Ø§Ø³Ø§Ø³ ID Ø±Ù†Ø¯ÙˆÙ… (Ù†ÛŒØ§Ø² Ø¨Ù‡ Ú©Ø§Ù„Ú©Ø´Ù† users ÙˆØ§Ù‚Ø¹ÛŒ Ø¯Ø§Ø±Ø¯)
      const memberIDs = userIDsString ? userIDsString.split(',').map(id => id.trim()) : [];
      
      // **ØªÙˆØ¬Ù‡:** Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù…Ø§ ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ID Ø±Ù†Ø¯ÙˆÙ… Ø´Ù…Ø§ Ø¨Ø§ UID ÙÙ†ÛŒ ÛŒÚ©Ø³Ø§Ù† Ø§Ø³Øª ÛŒØ§ Ø§Ø² Ù‚Ø¨Ù„ Ù…Ù¾ Ø´Ø¯Ù‡ Ø§Ø³Øª.
      // Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒØŒ ÙØ¹Ù„Ø§Ù‹ ÙÙ‚Ø· ID ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
      const membersUIDs = [currentUserID]; // Ø§Ø¯Ù…ÛŒÙ†
      
      // Ø§Ú¯Ø± Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ ÛŒÚ© ØªØ§Ø¨Ø¹ ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ ID Ø±Ù†Ø¯ÙˆÙ… Ø¨Ù‡ UID Ø¯Ø§Ø´ØªÛŒØ¯ØŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´Ø¯:
      // memberIDs.forEach(id => { membersUIDs.push(mapRandomIDToUID(id)); });

      const newChatId = `chat_${new Date().getTime()}`;
      
      // **Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† Ø¨Ù‡ Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§**
      const newChat = {
          chatId: newChatId,
          name: chatName,
          type: chatType,
          status: isGroup ? `${membersUIDs.length} members` : `Channel â€¢ ${membersUIDs.length} sub`,
          avatar: chatName[0],
          isAdmin: true,
          canSend: isGroup // ÙÙ‚Ø· Ú¯Ø±ÙˆÙ‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù¾ÛŒØ§Ù… Ø¨ÙØ±Ø³ØªØ¯
      };
      
      // **ØªÙˆØ¬Ù‡:** Ø¯Ø± ÙˆØ§Ù‚Ø¹ÛŒØªØŒ Ø§ÛŒÙ† Ú†Øª Ø¨Ø§ÛŒØ¯ Ø¯Ø± Firestore Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆØ¯ Ùˆ Ø³Ù¾Ø³ Ù„ÛŒØ³Ù†Ø± Ø¢Ù† Ø±Ø§ Ø¨Ú¯ÛŒØ±Ø¯.
      // ÙØ¹Ù„Ø§Ù‹ ÙÙ‚Ø· ÛŒÚ© Ø¢ÛŒØªÙ… Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù„ÛŒØ³Øª HTML Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
      addChatToList(newChat);
      
      showToast(`âœ… ${chatType} "${chatName}" Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!`);

      // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ú†Øª Ø¬Ø¯ÛŒØ¯
      openChatView(newChat);
  }
  
  // **ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¬Ø¯ÛŒØ¯: Ø§ÙØ²ÙˆØ¯Ù† Ø¢ÛŒØªÙ… Ú†Øª Ø¨Ù‡ Ù„ÛŒØ³Øª (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)**
  function addChatToList(chatInfo) {
      const list = document.getElementById('chats');
      const item = document.createElement('article');
      item.className = 'item';
      item.setAttribute('data-name', chatInfo.name);
      item.setAttribute('data-avatar', chatInfo.avatar);
      item.setAttribute('data-chat-id', chatInfo.chatId);
      item.setAttribute('data-pinned', 'false');
      
      const chatNameEncoded = JSON.stringify(chatInfo).replace(/"/g, '&quot;');

      // ØªÙ†Ø¸ÛŒÙ… Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù„Ù…Ø³ Ùˆ Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ø¢ÛŒØªÙ… Ø¬Ø¯ÛŒØ¯
      item.setAttribute('onmousedown', `startPress(this, '${chatInfo.name}', ${chatNameEncoded})`);
      item.setAttribute('ontouchstart', `startPress(this, '${chatInfo.name}', ${chatNameEncoded})`);
      item.setAttribute('onmouseup', 'cancelPress()');
      item.setAttribute('ontouchend', 'cancelPress()');
      item.setAttribute('onmousemove', 'cancelPress(true)');
      item.setAttribute('ontouchmove', 'cancelPress(true)');
      
      item.innerHTML = `
        <div class="left" style="background:${chatInfo.type === 'Ú¯Ø±ÙˆÙ‡' ? '#2ecc71' : '#3498db'}; color: #fff;">${chatInfo.avatar}</div>
        <div class="body">
          <div class="row1">
            <div class="name">${chatInfo.name}</div>
            <div class="time">NOW</div>
          </div>
          <div class="row2 muted-text">${chatInfo.type === 'Ú¯Ø±ÙˆÙ‡' ? 'New Group Created' : 'New Channel Created'}</div>
        </div>
        <div class="icon-right-container">
           <div class="badge primary">NEW</div>
        </div>
      `;
      list.prepend(item); // Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø¨Ø§Ù„Ø§
  }

  // --- Bot Helper Guide Content ---
  function populateBotHelperGuide() {
      const chatId = 'bot_4';
      const container = document.getElementById('chat-messages-container');
      
      // Ø§Ú¯Ø± Ú†Øª Ø¨Ø§Øª Ø¨Ø§Ø² Ù†ÛŒØ³ØªØŒ Ú©Ø§Ø±ÛŒ Ù†Ú©Ù†
      if (activeChatData && activeChatData.chatId !== chatId) return;
      
      container.innerHTML = ''; // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ

      const guideContent = [
          { sender: 'Bot Helper', text: "**ğŸ‘‹ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ Ø¨Ù‡ Ù¾ÛŒØ§Ù…â€ŒØ±Ø³Ø§Ù†!**" },
          { sender: 'Guide', text: "Ø§ÛŒÙ† ÛŒÚ© Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³Ø±ÛŒØ¹ Ø§Ø² Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§Ø³Øª. \n\nÛ±. **Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª:** Ù¾Ø³ Ø§Ø² Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…ØŒ ÛŒÚ© ID Ø±Ù†Ø¯ÙˆÙ… Û±Û± Ø±Ù‚Ù…ÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯. \n Û². **Ù…Ø´Ø®ØµØ§Øª:** Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ IDØŒ Ù†Ø§Ù… Ùˆ Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø² Ù…Ù†ÙˆÛŒ Ø³Ù…Øª Ø±Ø§Ø³Øª (Û³ Ù†Ù‚Ø·Ù‡) Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†ÛŒØ¯.", isQuote: true },
          { sender: 'Bot Helper', text: "Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø±ÙˆÛŒ Ø¢ÛŒÚ©ÙˆÙ† Ù‚Ù„Ù… Ø¢Ø¨ÛŒ Ø¯Ø± Ù¾Ø§ÛŒÛŒÙ† Ø³Ù…Øª Ø±Ø§Ø³Øª Ø¨Ø²Ù†ÛŒØ¯." },
          { sender: 'Guide', text: "**Û³. Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ø±ÙˆÙ‡/Ú©Ø§Ù†Ø§Ù„:** Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¯Ú©Ù…Ù‡ Ù‚Ù„Ù…ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ú¯Ø±ÙˆÙ‡ ÛŒØ§ Ú©Ø§Ù†Ø§Ù„ Ø®ØµÙˆØµÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯ Ùˆ Ø§Ø¹Ø¶Ø§ Ø±Ø§ Ø¨Ø§ ID Ø±Ù†Ø¯ÙˆÙ… (ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø§Ø¯ Ú©Ù†Ø¯) Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.", isQuote: true },
          { sender: 'Bot Helper', text: "Ù‡Ù…Ú†Ù†ÛŒÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Ø§ÛŒÙ…ÙˆØ¬ÛŒâ€ŒÙ‡Ø§ Ø¯Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯." },
          { sender: 'Guide', text: "**Û´. Ø§ÛŒÙ…ÙˆØ¬ÛŒ:** Ø¢ÛŒÚ©ÙˆÙ† ØµÙˆØ±ØªÚ© Ø¯Ø± Ú©Ù†Ø§Ø± Ú©Ø§Ø¯Ø± Ù¾ÛŒØ§Ù… ÙØ¹Ø§Ù„ Ø§Ø³Øª. Ø¨Ø§ Ú©Ù„ÛŒÚ©ØŒ ÛŒÚ© Ù¾Ø§Ù„Øª Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯ ØªØ§ Ø¨ØªÙˆØ§Ù†ÛŒØ¯ Ø§ÛŒÙ…ÙˆØ¬ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.", isQuote: true },
          { sender: 'Bot Helper', text: "Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¯Ø± Ø§ÛŒÙ† Ú©Ø§Ù†Ø§Ù„ ÙÙ‚Ø· Ø¨Ù‡ ØµÙˆØ±Øª Ø±Ø§Ù‡Ù†Ù…Ø§ Ùˆ Ù†Ù‚Ù„ Ù‚ÙˆÙ„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ Ùˆ Ù‚Ø§Ø¨Ù„ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù†Ø¯Ø§Ø±ÛŒØ¯." },
          { sender: 'Guide', text: "**Ûµ. Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…:** ØªÙ…Ø§Ù… Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ÛŒ Ø´Ù…Ø§ Ø¯Ø± Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§/Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ø³ÛŒÙˆ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ Ùˆ Ø¨Ø§ Ø®Ø§Ø±Ø¬ Ø´Ø¯Ù† Ùˆ Ø¨Ø§Ø²Ú¯Ø´ØªÙ† Ú©Ø§Ø±Ø¨Ø± Ù¾Ø§Ú© Ù†Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.", isQuote: true }
      ];

      guideContent.forEach((msg, index) => {
          const isSent = msg.sender === 'Bot Helper'; // Bot Helper Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÙØ±Ø³ØªÙ†Ø¯Ù‡ (Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯Ù‡ Ú©Ø§Ø±Ø¨Ø±) Ø¯Ø± Ù†Ø¸Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
          const timeString = `0${index + 1}:00`; 
          
          const bubble = document.createElement('div');
          bubble.className = `chat-message-bubble ${isSent ? 'received' : 'sent'}`; // Ø¨Ø±Ø¹Ú©Ø³ Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ø¹Ø§Ø¯ÛŒØŒ Ù¾ÛŒØ§Ù… Ø±Ø§Ù‡Ù†Ù…Ø§ (Ù†Ù‚Ù„ Ù‚ÙˆÙ„) Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª "Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡" Ø¯Ø± Ù†Ø¸Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ….

          let contentHtml = msg.text;

          if (msg.isQuote) {
              contentHtml = `<div class="quote-text">${msg.text}</div>`;
          }

          bubble.innerHTML = `
              ${contentHtml}
              <small>
                  ${msg.sender} â€¢ ${timeString}
              </small>
          `;
          
          container.appendChild(bubble);
      });
      container.scrollTop = container.scrollHeight;
  }
  
  // **ØªØ§Ø¨Ø¹ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† listenForChatMessages Ø¨Ø±Ø§ÛŒ Bot Helper**
  function listenForChatMessages(chatId) {
      if (currentChatListener) {
          currentChatListener();
          currentChatListener = null;
      }
      
      if (chatId === 'bot_4') {
          // Ø¨Ø±Ø§ÛŒ Bot HelperØŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø±Ø§Ù‡Ù†Ù…Ø§ Ø±Ø§ Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯
          populateBotHelperGuide();
      } else {
          // Ø¨Ø±Ø§ÛŒ Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ø¹Ø§Ø¯ÛŒØŒ Ø¨Ù‡ Firestore Ú¯ÙˆØ´ Ø¯Ù‡ÛŒØ¯
          const messagesRef = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp', 'asc');
          const container = document.getElementById('chat-messages-container');
          container.innerHTML = ''; 

          currentChatListener = messagesRef.onSnapshot(snapshot => {
              snapshot.docChanges().forEach(change => {
                  const messageData = change.doc.data();
                  const messageId = change.doc.id;
                  
                  if (change.type === "added") {
                      appendMessageToChat(messageId, messageData);
                      if (messageData.senderId !== currentUserID && !messageData.seenBy.includes(currentUserID)) {
                          updateMessageReadStatus(chatId, messageId);
                      }
                  }
                  
                  if (change.type === "modified") {
                      const existingBubble = document.getElementById(`msg-${messageId}`);
                      if (existingBubble) {
                          updateMessageBubble(existingBubble, messageData);
                      }
                  }
              });
              container.scrollTop = container.scrollHeight;
          }, error => {
              console.error("Error listening to messages:", error);
          });
      }
  }


  // Call initialization when the window loads
  window.onload = () => {
      showAuthScreen();
      const input = document.getElementById('chat-input');
      if (input) {
          input.addEventListener('input', updateSendButton);
          updateSendButton(); 
      }
      document.getElementById('chat-back-btn').onclick = closeChatView;
      // Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡ Compose (Ù‚Ù„Ù… Ø¢Ø¨ÛŒ)
      document.getElementById('compose-button').onclick = startNewChat;
  }

</script>
<style>
  :root{
    /* Light Theme (Telegram Blue) */
    --bg-primary:#517da7;
    --bg-surface:#ffffff;
    --bg-content:#f3f4f6;
    --color-text:#1f2326;
    --color-muted:#9da9b3;
    --color-accent:#4da3ff;
    --color-red:#e74c3c;
    --round:12px;
    --shadow-subtle: 0 4px 12px rgba(0,0,0,0.1);
    
    /* Animation Speeds */
    --transition-speed: 250ms;

    /* Long Press Menu Shadow */
    --menu-shadow: 0 8px 16px rgba(0,0,0,0.25);
  }

  /* Base Styles */
  body {
    background:var(--bg-content);
    color: var(--color-text);
  }
  
  html,body{
    height:100%;margin:0;font-family:'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    overflow:hidden;touch-action:none;box-sizing:border-box;
    -webkit-user-select: none; user-select: none;
  }
  .app {
    height:100vh;width:100vw;display:flex;flex-direction:column;background:var(--bg-content);box-sizing:border-box;
    position:relative;
  }

  /* **Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª Ø¢Ù¾Ù„ÙˆØ¯ Ø§Ø³ØªÙˆØ±ÛŒ** */
  .upload-progress-bar {
      position: fixed; bottom: 0; right: 0; left: 0;
      height: 4px; background: #eee;
      z-index: 500;
      display: none;
  }
  .progress-fill {
      height: 100%;
      width: 0%;
      background: var(--color-accent);
      transition: width 100ms linear;
  }
  .progress-text {
      position: fixed; bottom: 12px; left: 50%; 
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7); color: #fff;
      padding: 4px 8px; border-radius: 4px;
      font-size: 12px;
      z-index: 501;
      display: none;
  }
  
  /* **ØµÙØ­Ù‡ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª (Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† ÙÛŒÙ„Ø¯ Ø§ÛŒÙ…ÛŒÙ„)** */
  .auth-screen {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg-primary); 
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      color: #fff; z-index: 300;
  }
  .auth-box {
      background: var(--bg-surface);
      padding: 30px; border-radius: var(--round);
      box-shadow: var(--shadow-subtle);
      width: 90%; max-width: 350px;
      color: var(--color-text); text-align: center;
  }
  .auth-box h2 { color: var(--bg-primary); margin-top: 0; }
  .auth-box input {
      width: 100%; padding: 12px; margin-bottom: 15px;
      border: 1px solid var(--bg-content); border-radius: 6px;
      box-sizing: border-box; font-size: 16px;
  }
  .auth-box button {
      width: 100%; padding: 12px; margin-top: 10px;
      background: var(--color-accent); color: #fff;
      border: none; border-radius: 6px; font-size: 16px;
      cursor: pointer;
  }

  /* --- HEADER AREA --- */
  .top {
    background:var(--bg-primary);
    color:#fff;
    position:relative;
    box-shadow: var(--shadow-subtle);
    z-index: 100;
    display: flex; flex-direction: column;
    transition: all 250ms ease;
  }
  
  .top-row-container {
      position: relative;
      height: 50px;
      display: flex; align-items: center;
      padding: 0 16px;
  }

  .top-row-normal {
      width: 100%; display: flex; align-items: center; gap: 12px;
      transition: opacity 200ms ease;
  }
  .top-row-normal.hidden { opacity: 0; pointer-events: none; display: none; }

  .search-bar-active {
      width: 100%; display: none; align-items: center; gap: 12px;
      animation: fadeIn 200ms ease;
  }
  .search-bar-active.visible { display: flex; }
  
  .search-input {
      flex: 1; background: rgba(255,255,255,0.2); border: none; 
      border-radius: 6px; padding: 6px 12px; color: #fff; font-size: 15px; outline: none;
  }
  .search-input::placeholder { color: rgba(255,255,255,0.7); }

  .hamburger{ width:24px;height:24px;cursor:pointer;display:flex;align-items:center;justify-content:center; }
  .hamburger svg path {fill: #fff;}
  .title{flex:1;font-weight:600;font-size:18px;text-align:left;letter-spacing:0.4px;}
  .search { width:22px;height:22px;opacity:0.95;cursor:pointer; }
  
  /* Stories */
  .stories {
    margin-top: 4px; display:flex; gap:14px; align-items:center; overflow-x:scroll;
    padding: 4px 16px 12px; 
    -webkit-overflow-scrolling:touch;
    scrollbar-width: none;
    transition: max-height 300ms ease, opacity 200ms ease, padding 300ms ease;
    max-height: 100px; 
    opacity: 1;
  }
  .stories.collapsed {
      max-height: 0; opacity: 0; padding: 0 16px; pointer-events: none;
  }
  .stories::-webkit-scrollbar { display: none; }

  .story {display:flex;flex-direction:column;align-items:center;gap:4px;min-width:62px;}
  
  .story .ring {
    width: 60px; height: 60px; 
    border-radius: 50%;
    background: linear-gradient(180deg, #3390ec, #00e5ff); 
    padding: 2px; 
    display: flex; align-items: center; justify-content: center;
    transition: transform 150ms ease;
  }
  .story .ring:active { transform: scale(0.95); }

  .story .avatar {
    width: 100%; height: 100%; border-radius: 50%;
    background: var(--bg-primary); 
    border: 2px solid var(--bg-primary); 
    box-sizing: border-box;
    display: flex; align-items: center; justify-content: center;
    font-weight: 600; color: #fff; font-size: 20px;
    position: relative;
    background-color: var(--bg-content); color: #555;
  }

  .story small{font-size:11px;color:#fff; margin-top: 2px;}

  /* Tabs */
  .tabs {
    display:flex;gap:8px;margin-top:0;align-items:center;justify-content:left;
    padding: 0 16px 10px; 
    transition: max-height 300ms ease, opacity 200ms ease, padding 300ms ease;
    max-height: 50px; opacity: 1;
  }
  .tabs.collapsed {
      max-height: 0; opacity: 0; padding: 0 16px; pointer-events: none;
  }
  .tab{
    background:rgba(255,255,255,0.15);padding:6px 12px;border-radius:999px;
    color:#fff;font-weight:500;font-size:13px;cursor:pointer;
  }
  .tab.active{background:#fff;color:var(--bg-primary);box-shadow: 0 4px 10px rgba(0,0,0,0.1)}

  /* Content List */
  .content {
    flex:1;overflow-y:auto;padding:12px;padding-bottom:100px;
    -webkit-overflow-scrolling:touch;
  }
  .list {display:flex;flex-direction:column;gap:10px;}
  
  .item {
    background:var(--bg-surface);border-radius:var(--round);display:flex;align-items:center;gap:12px;
    padding:12px;box-shadow: 0 1px 4px rgba(0,0,0,0.05);position:relative;overflow: hidden;
    transition: all 300ms ease;
    cursor: pointer; 
  }
  .item.hidden-search { display: none !important; }
  .item:active {background: var(--bg-content);}
  .item .left {
    width:56px;height:56px;border-radius:var(--round);flex:0 0 56px;display:flex;align-items:center;justify-content:center;
    background:linear-gradient(180deg,#fff,#f8f8f8);box-shadow: inset 0 -6px 10px rgba(0,0,0,0.02);
    font-size: 20px; font-weight: 700; color: #555;
  }
  .item .body{flex:1;min-width:0;text-align:left;}
  .item .body .row1{display:flex;align-items:center;justify-content:space-between;gap:8px;}
  .name{font-weight:600;font-size:16px;}
  .muted-text{color:var(--color-muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .time{font-size:12px;color:var(--color-muted);flex-shrink:0}
  
  /* Right Icon / Badge / Pin */
  .icon-right-container {
      display: flex; flex-direction: column; align-items: flex-end; gap: 4px;
  }
  .badge{
    min-width:24px;height:24px;border-radius:12px;display:flex;align-items:center;justify-content:center;
    background:#e0e7ed;color:#555;font-weight:600;flex-shrink:0;font-size:12px; padding: 0 4px;
  }
  .badge.primary { background: var(--color-accent); color: #fff; }
  .badge.muted { background: var(--color-muted); color: #fff; opacity: 0.7; }
  
  .pin-icon { width: 14px; height: 14px; fill: var(--color-muted); display: none; transform: rotate(45deg); }
  /* Pinned State Styles */
  .item.pinned .pin-icon { display: block; fill: var(--bg-primary); }
  .item.pinned { background: #f8fbff; border-left: 3px solid var(--bg-primary); }

  /* Chat View (Fixed) */
  .chat-view {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--bg-content); display: flex; flex-direction: column;
    transform: translateX(100%); 
    z-index: 120;
    transition: transform var(--transition-speed) cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  .chat-view.active { transform: translateX(0); }

  .chat-header {
    background: var(--bg-primary); padding: 8px 16px; color: #fff;
    display: flex; align-items: center; gap: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); flex-shrink: 0;
  }
  .chat-header .back-btn svg path, .chat-header .more-chat-options svg path { fill: #fff; }
  .chat-header .chat-avatar { width: 40px; height: 40px; border-radius: 50%; background: #fff; font-weight: 700; color: #555; flex-shrink: 0; display: flex; justify-content: center; align-items: center;}
  .chat-header .chat-name { font-weight: 600; font-size: 17px; }
  .chat-header .chat-status { font-size: 11px; color: rgba(255,255,255,0.8); }

  .chat-messages {
    flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 8px;
    padding-bottom: 80px; 
    background: var(--bg-content); 
  }
  .chat-message-bubble {
    max-width: 80%; padding: 10px 14px; border-radius: 18px;
    background: var(--bg-surface); box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    align-self: flex-start; text-align: left;
    /* RTL adjustments */
    text-align: right;
  }
  .chat-message-bubble.sent {
    background: #d1eaff; 
    align-self: flex-end;
  }
  .chat-message-bubble small {
    display: flex; font-size: 10px; color: var(--color-muted); margin-top: 4px; 
    justify-content: flex-end; align-items: center; gap: 4px;
  }
  
  /* **Ø¬Ø¯ÛŒØ¯: Ø§Ø³ØªØ§ÛŒÙ„ Ù†Ù‚Ù„ Ù‚ÙˆÙ„ (Ø¨Ø±Ø§ÛŒ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¨Ø§Øª)** */
  .quote-text {
      border-right: 3px solid #62b1f6; /* Ù†ÙˆØ§Ø± Ø¢Ø¨ÛŒ Ø±Ù†Ú¯ */
      padding-right: 8px;
      margin-left: 0; /* Ø­Ø°Ù Ù…Ø§Ø±Ø¬ÛŒÙ† Ø§Ø¶Ø§ÙÛŒ Ø¯Ø± RTL */
      color: #62b1f6; /* Ø±Ù†Ú¯ Ù…ØªÙ† Ù†Ù‚Ù„ Ù‚ÙˆÙ„ */
      font-style: italic;
      white-space: pre-wrap; /* Ø­ÙØ¸ Ø®Ø·ÙˆØ· Ø¬Ø¯ÛŒØ¯ (\n) */
      font-size: 14px;
  }

  /* ØªÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒØ¯Ù‡ Ø´Ø¯Ù† */
  .read-status-container {
      display: inline-flex;
      align-items: center;
      margin-right: 4px;
      margin-left: 0;
  }
  .read-status {
      font-size: 14px; 
      line-height: 1;
      height: 10px;
      color: var(--color-muted); 
      margin-left: -2px; 
  }
  .double-tick-partial {
      color: var(--color-muted);
      opacity: 1;
  }
  .double-tick-full {
      color: var(--color-accent); 
      font-weight: 600;
  }

  /* Message Input Bar */
  .message-bar {
    position:fixed; bottom:0; right:0; left:0;
    background:var(--bg-surface); padding:8px 12px;
    display:flex; align-items:flex-end; gap:8px;
    box-shadow: 0 -2px 8px rgba(0,0,0,0.08);
    transform: translateY(100%); 
    z-index: 130; 
    transition: transform var(--transition-speed) ease-out;
  }
  .message-bar.active { transform: translateY(0); }
  
  .message-input-container {
      flex: 1; display: flex; align-items: center;
      background: var(--bg-content); border-radius: 22px;
      padding: 0 10px;
      position: relative; /* Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø§ÛŒÙ…ÙˆØ¬ÛŒ Ù¾ÛŒÚ©Ø± */
  }
  .message-bar input {
    flex:1; padding:10px 0; border:none;
    background:transparent; font-size:15px; color: var(--color-text);
  }
  .message-bar input:focus { outline: none; }
  .attach-btn, .emoji-btn {
      width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
      cursor: pointer;
  }
  .attach-btn svg { transform: rotate(135deg); }
  .attach-btn svg path, .emoji-btn svg path { fill: var(--color-muted); }

  .message-bar button {
    background:var(--color-accent); color:#fff; border:none;
    width:40px;height:40px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    font-size:18px; cursor:pointer; flex-shrink: 0;
    transition: background 150ms ease;
  }

  /* **Ø¬Ø¯ÛŒØ¯: Emoji Picker** */
  .emoji-picker {
      position: absolute;
      bottom: 50px; /* Ø¨Ø§Ù„Ø§ÛŒ Ù†ÙˆØ§Ø± Ù¾ÛŒØ§Ù… */
      right: 0;
      background: var(--bg-surface);
      box-shadow: var(--shadow-subtle);
      padding: 10px;
      border-radius: var(--round);
      display: none;
      flex-wrap: wrap;
      gap: 5px;
      max-width: 250px;
      z-index: 140;
  }
  .emoji-picker.active {
      display: flex;
      animation: fadeIn 200ms ease;
  }
  .emoji-item {
      font-size: 24px;
      padding: 4px;
      cursor: pointer;
      border-radius: 4px;
      transition: background 100ms ease;
  }
  .emoji-item:hover {
      background: var(--bg-content);
  }

  /* Floating Compose Button (Ù‚Ù„Ù… Ø¢Ø¨ÛŒ) */
  .compose{
    position:fixed; right:24px; bottom:24px;
    width:56px;height:56px;border-radius:50%;
    background:var(--color-accent);display:flex;align-items:center;justify-content:center;
    box-shadow: 0 8px 18px rgba(77,163,255,0.35);
    cursor:pointer; z-index: 95;
    transition: opacity var(--transition-speed) ease, transform var(--transition-speed) ease;
  }
  .compose svg path {fill: #fff;}

  /* Drawer (Sidebar) */
  .drawer-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); 
    z-index: 200; 
    opacity: 0; pointer-events: none;
    transition: opacity var(--transition-speed) ease;
  }
  .drawer-overlay.active { opacity: 1; pointer-events: auto; }
  .drawer {
    position: fixed; top: 0; left: 0; width: 80%; max-width: 300px; height: 100%;
    background: var(--bg-primary); 
    z-index: 210; 
    transform: translateX(-100%);
    transition: transform var(--transition-speed) ease;
    box-shadow: 4px 0 12px rgba(0,0,0,0.1);
    display: flex; flex-direction: column;
    color: #fff;
  }
  .drawer.active { transform: translateX(0); }
  .drawer-header {
    padding: 24px 16px 16px; border-bottom: 1px solid rgba(255,255,255,0.2);
    cursor: pointer; /* Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…Ø´Ø®ØµØ§Øª */
  }
  .drawer-avatar {
    width: 64px; height: 64px; border-radius: 50%; background: #fff;
    font-size: 24px; font-weight: 700; color: #555;
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 10px;
  }
  .drawer-avatar-name { font-size: 18px; font-weight: 600; }
  .drawer-avatar-phone { font-size: 13px; color: rgba(255,255,255,0.8); }

  .drawer-menu {
    flex: 1; overflow-y: auto; padding: 8px 0;
  }
  .drawer-item {
    padding: 12px 16px; display: flex; align-items: center; gap: 16px;
    font-size: 16px; font-weight: 500; cursor: pointer;
    transition: background 150ms ease;
  }
  .drawer-item:hover { background: rgba(255,255,255,0.1); }
  .drawer-item svg { width: 24px; height: 24px; fill: #fff; }

  /* --- Long Press Context Menu --- */
  .long-press-menu {
    position: fixed; top: 50%; left: 50%; 
    transform: translate(-50%, -50%) scale(0.9);
    opacity: 0;
    background: var(--bg-surface);
    border-radius: var(--round);
    padding: 8px 0;
    min-width: 200px;
    z-index: 250; 
    box-shadow: var(--menu-shadow);
    transition: all 150ms ease-out;
    pointer-events: none;
  }

  .long-press-menu.active {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
    pointer-events: auto;
  }
  
  .long-press-item {
    display: flex; align-items: center; gap: 12px;
    padding: 10px 16px;
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    color: var(--color-text);
    transition: background 100ms ease;
  }
  .long-press-item:hover {
    background: var(--bg-content);
  }
  .long-press-item svg {
    width: 20px; height: 20px;
    fill: var(--color-muted);
  }
  .long-press-item.delete {
    color: var(--color-red);
  }
  .long-press-item.delete svg {
    fill: var(--color-red);
  }
  .long-press-menu-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 240;
    pointer-events: none; 
  }
  
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

</style>
</head>
<body class="light-theme">

<div class="upload-progress-bar" id="upload-progress-bar">
    <div class="progress-fill" id="progress-fill"></div>
</div>
<div class="progress-text" id="progress-text">0%</div>

<div class="auth-screen" id="auth-screen">
    <div class="auth-box">
        <h2>ÙˆØ±ÙˆØ¯/Ø«Ø¨Øª Ù†Ø§Ù…</h2>
        <input type="text" id="auth-username" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
        <input type="email" id="auth-email" placeholder="Ø§ÛŒÙ…ÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)">
        <input type="password" id="auth-password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
        <button onclick="registerOrLogin(true)">Ø«Ø¨Øª Ù†Ø§Ù… Ùˆ ØªÙˆÙ„ÛŒØ¯ ID Ø±Ù†Ø¯ÙˆÙ…</button>
        <button style="background: #ccc; color: var(--color-text);" onclick="registerOrLogin(false)">ÙˆØ±ÙˆØ¯</button>
        <p style="font-size: 12px; color: var(--color-muted); margin-top: 20px;">
            <span style="color: var(--color-red);">ØªÙˆØ¬Ù‡:</span> ID Û±Û± Ø±Ù‚Ù…ÛŒ Ù¾Ø³ Ø§Ø² Ø«Ø¨Øª Ù†Ø§Ù… ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
        </p>
    </div>
</div>

<div class="app" role="application" aria-label="Messenger UI" id="app-ui">
  
  <div class="drawer-overlay" id="drawer-overlay" onclick="closeDrawer()"></div>
  <div class="drawer" id="drawer">
    <div class="drawer-header" onclick="showAccountInfo()">
      <div class="drawer-avatar" id="drawer-avatar">G</div>
      <div class="drawer-avatar-name" id="drawer-avatar-name">Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒÙ‡Ù…Ø§Ù†</div>
      <div class="drawer-avatar-phone" id="drawer-avatar-phone">ID: ...</div>
    </div>
    <div class="drawer-menu">
      <div class="drawer-item" onclick="flash('New Group')">
        <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-4 0c1.66 0 2.99-1.34 2.99-3S13.66 5 12 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm6.5 4H19v6h-2v-4h-2.5c-.34 0-.67.04-1 .11V15c-1.37-.56-2.92-.89-4.5-.89s-3.13.33-4.5.89v1.11c-.33-.07-.66-.11-1-.11H5v4H3v-6h1.5A3.5 3.5 0 018 11.5V11c0-1.66 1.34-3 3-3h2c1.66 0 3 1.34 3 3v.5a3.5 3.5 0 013.5 3.5z"/></svg>
        <span>New Group</span>
      </div>
      <div class="drawer-item" onclick="flash('Contacts')">
        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
        <span>Contacts</span>
      </div>
      <div class="drawer-item" onclick="showAccountInfo()">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
        <span>Ù…Ø´Ø®ØµØ§Øª Ù…Ù† (ID)</span>
      </div>
      <div class="drawer-item" onclick="logoutUser()" style="margin-top: 20px; color: var(--color-red);">
        <svg viewBox="0 0 24 24" style="fill: var(--color-red);"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5-5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
        <span>Ø®Ø±ÙˆØ¬</span>
      </div>
    </div>
  </div>

  <header class="top" role="banner" id="main-header">
    <div class="top-row-container">
        <div class="top-row-normal" id="top-row-normal">
            <div class="hamburger clickable" title="Menu" onclick="openDrawer()">
                <svg viewBox="0 0 24 24" width="24" height="24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
            </div>
            <div class="title">Chats</div>
            <svg class="search clickable" viewBox="0 0 24 24" onclick="toggleSearchBar(true)" width="24" height="24" style="fill: #fff;">
                <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.5 21.5 20l-6-6z"/>
            </svg>
        </div>
        
        <div class="search-bar-active" id="search-bar-active">
             <div class="hamburger clickable" onclick="toggleSearchBar(false)">
                <svg width="24" height="24" viewBox="0 0 24 24"><path fill="#fff" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
             </div>
             <input type="text" class="search-input" id="search-input" placeholder="Search chats..." oninput="filterChats(this.value)">
        </div>
    </div>

    <div class="stories" aria-hidden="false" id="stories-section">
      <div class="story clickable" onclick="document.getElementById('story-file-input').click()">
        <input type="file" id="story-file-input" accept="image/*,video/*" style="display: none;" onchange="handleStoryFileSelect(event)">
        
        <div class="ring">
            <div class="avatar" style="background: #517da7; color: #fff;">+</div>
        </div>
        <small>My Story</small>
      </div>
      <div class="story clickable" onclick="flash('Story: Elon')">
        <div class="ring"><div class="avatar" style="background: #e0e7ed;">E</div></div>
        <small>Elon Musk</small>
      </div>
      <div class="story clickable" onclick="flash('Story: Group')">
        <div class="ring"><div class="avatar" style="background: #e0e7ed;">G</div></div>
        <small>Project X</small>
      </div>
    </div>

    <div class="tabs" role="tablist" aria-label="Tabs" id="tabs-section">
      <div class="tab active clickable" onclick="selectTab(this)">All</div>
      <div class="tab clickable" onclick="selectTab(this)">Work</div>
      <div class="tab clickable" onclick="selectTab(this)">Unread</div>
      <div class="tab clickable" onclick="selectTab(this)">Bots</div>
    </div>
  </header>

  <div class="content-wrapper" style="flex: 1; position: relative;">
    <main class="content" role="main" id="main-content-list">
      <section class="list" id="chats" aria-label="Chat List">
        
        <article class="item pinned" 
                 data-name="Global News" 
                 data-avatar="N"
                 data-chat-id="news_channel_1"
                 data-pinned="true"
                 onmousedown="startPress(this, 'Global News', {name:'Global News', avatar:'N', status:'Channel â€¢ 1.2M subs', isPinned: true, chatId: 'news_channel_1'})"
                 ontouchstart="startPress(this, 'Global News', {name:'Global News', avatar:'N', status:'Channel â€¢ 1.2M subs', isPinned: true, chatId: 'news_channel_1'})"
                 onmouseup="cancelPress()"
                 ontouchend="cancelPress()"
                 onmousemove="cancelPress(true)"
                 ontouchmove="cancelPress(true)">
          <div class="left" style="background:linear-gradient(135deg,#ffaa00,#ffe080); color: #fff;">N</div>
          <div class="body">
            <div class="row1">
              <div class="name">Global News</div>
              <div class="time">NOW</div>
            </div>
            <div class="row2 muted-text">Latest breaking news summary...</div>
          </div>
          <div class="icon-right-container">
             <div class="badge muted">X</div>
             <svg class="pin-icon" viewBox="0 0 24 24"><path d="M16 12V4H8v8l-2 2v2h6v6h4v-6h6v-2l-2-2z"/></svg>
          </div>
        </article>

        <article class="item" 
                 data-name="Sarah Jones" 
                 data-avatar="S"
                 data-chat-id="sarah_jones_2"
                 data-pinned="false"
                 onmousedown="startPress(this, 'Sarah Jones', {name:'Sarah Jones', avatar:'S', status:'online', chatId: 'sarah_jones_2'})"
                 ontouchstart="startPress(this, 'Sarah Jones', {name:'Sarah Jones', avatar:'S', status:'online', chatId: 'sarah_jones_2'})"
                 onmouseup="cancelPress()"
                 ontouchend="cancelPress()"
                 onmousemove="cancelPress(true)"
                 ontouchmove="cancelPress(true)">
          <div class="left" style="background:#f1c40f; color: #fff;">S</div>
          <div class="body">
            <div class="row1">
              <div class="name">Sarah Jones</div>
              <div class="time">13:45</div>
            </div>
            <div class="row2 muted-text">Hey, did you finish the report?</div>
          </div>
          <div class="icon-right-container">
             <div class="badge primary">3</div>
          </div>
        </article>
        
        <article class="item" 
                 data-name="Dev Team" 
                 data-avatar="D"
                 data-chat-id="dev_team_3"
                 data-pinned="false"
                 onmousedown="startPress(this, 'Dev Team', {name:'Dev Team', avatar:'D', status:'3 members', chatId: 'dev_team_3'})"
                 ontouchstart="startPress(this, 'Dev Team', {name:'Dev Team', avatar:'D', status:'3 members', chatId: 'dev_team_3'})"
                 onmouseup="cancelPress()"
                 ontouchend="cancelPress()"
                 onmousemove="cancelPress(true)"
                 ontouchmove="cancelPress(true)">
          <div class="left" style="background:#3498db; color: #fff;">D</div>
          <div class="body">
            <div class="row1">
              <div class="name">Dev Team</div>
              <div class="time">10:00</div>
            </div>
            <div class="row2 muted-text">Deployment successfully completed.</div>
          </div>
          <div class="icon-right-container">
             <div class="badge">âœ“</div>
          </div>
        </article>
        
        <article class="item" 
                 data-name="Bot Helper" 
                 data-avatar="B"
                 data-chat-id="bot_4"
                 data-pinned="false"
                 onmousedown="startPress(this, 'Bot Helper', {name:'Bot Helper', avatar:'B', status:'Guide', chatId: 'bot_4'})"
                 ontouchstart="startPress(this, 'Bot Helper', {name:'Bot Helper', avatar:'B', status:'Guide', chatId: 'bot_4'})"
                 onmouseup="cancelPress()"
                 ontouchend="cancelPress()"
                 onmousemove="cancelPress(true)"
                 ontouchmove="cancelPress(true)">
          <div class="left" style="background:#9b59b6; color: #fff;">B</div>
          <div class="body">
            <div class="row1">
              <div class="name">Bot Helper</div>
              <div class="time">Guide</div>
            </div>
            <div class="row2 muted-text">Welcome! (Read Only Guide)</div>
          </div>
          <div class="icon-right-container">
          </div>
        </article>
        
      </section>
    </main>
  </div>

  <div class="compose clickable" id="compose-button" title="New Group/Channel">
    <svg viewBox="0 0 24 24" width="24" height="24"><path d="M4 17.5V20h2.5L17.81 8.69l-2.5-2.5L4 17.5zM20.71 5.99a.996.996 0 000-1.41l-2.5-2.5a.996.996 0 00-1.41 0L15.31 3.29l2.5 2.5 2.9-2.9z"/></svg>
  </div>

  <div class="long-press-menu-overlay" id="long-press-menu-overlay" onclick="cancelPress()"></div>
  <div class="long-press-menu" id="long-press-menu">
    <div class="long-press-item" onclick="flash('Pin/Unpin')">
        <svg viewBox="0 0 24 24"><path d="M16 12V4H8v8l-2 2v2h6v6h4v-6h6v-2l-2-2z"/></svg>
        <span>Pin / Unpin</span>
    </div>
    <div class="long-press-item" onclick="flash('Mute/Unmute')">
        <svg viewBox="0 0 24 24"><path d="M12 4.5v15l5.25-5.25H21V9.75h-3.75zM4.5 9.75h3v4.5h-3z"/></svg>
        <span>Mute / Unmute</span>
    </div>
    <div class="long-press-item" onclick="flash('Archive')">
        <svg viewBox="0 0 24 24"><path d="M21 21v-2H3v2h18zM3 3v2h18V3H3zm13 9H8l4-4 4 4z"/></svg>
        <span>Archive</span>
    </div>
    <div class="long-press-item delete" onclick="flash('Delete Chat')">
        <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zm2.46-7.12l1.41-1.41L12 12.17l2.12-2.12 1.41 1.41L13.41 14l2.12 2.12-1.41 1.41L12 15.83l-2.12 2.12-1.41-1.41L10.59 14 8.46 11.88zM15 4l-1-1H9L8 4H5v2h14V4z"/></svg>
        <span>Delete Chat</span>
    </div>
  </div>

  <div class="chat-view" id="chat-view">
    <div class="chat-header">
      <div class="back-btn clickable" id="chat-back-btn">
        <svg width="24" height="24" viewBox="0 0 24 24"><path fill="#fff" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      </div>
      <div class="chat-avatar" id="chat-avatar-display">?</div>
      <div style="flex: 1; min-width: 0;">
        <div class="chat-name" id="chat-name-display">Chat Name</div>
        <div class="chat-status" id="chat-status-display">status</div>
      </div>
      <div class="more-chat-options clickable" onclick="flash('Chat Options')">
        <svg width="24" height="24" viewBox="0 0 24 24"><path fill="#fff" d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
      </div>
    </div>
    
    <div class="chat-messages" id="chat-messages-container">
      </div>

    <div class="message-bar" id="message-bar">
      <div class="message-input-container">
        <div class="emoji-btn clickable" onclick="toggleEmojiPicker()">
            <svg viewBox="0 0 24 24" width="24" height="24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm0-10c-2.2 0-4-1.8-4-4s1.8-4 4-4 4 1.8 4 4-1.8 4-4 4zm4.5 4c-.75 0-1.4-.44-1.74-1.07-.46-.86-1.54-1.43-2.76-1.43-1.22 0-2.3.57-2.76 1.43-.34.63-.99 1.07-1.74 1.07-1.03 0-1.87-.84-1.87-1.87 0-1.03.84-1.87 1.87-1.87.56 0 1.09.25 1.45.68.83-1.08 2.05-1.74 3.55-1.74s2.72.66 3.55 1.74c.36-.43.89-.68 1.45-.68 1.03 0 1.87.84 1.87 1.87 0 1.03-.84 1.87-1.87 1.87z"/></svg>
        </div>
        <input type="text" id="chat-input" placeholder="Message..." dir="rtl">
        <div class="attach-btn clickable" id="attach-btn" onclick="flash('Attach File Menu')">
            <svg viewBox="0 0 24 24" width="24" height="24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
        </div>
        <div class="emoji-picker" id="emoji-picker"></div>
      </div>
      <button id="send-btn" onclick="handleSendButtonClick()">
         </button>
    </div>
  </div>
</div>

</body>
</html>
